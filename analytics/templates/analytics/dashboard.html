{% extends "base.html" %}
{% load static %}
{% block title %}{{ sous_thematique.nom }} - Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/insee.css' %}">
<link rel="stylesheet" href="{% static 'css/modal_delete_chart.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container">
    <h2>{{ sous_thematique.nom }}</h2>
    <p><strong>Th√©matique :</strong> {{ sous_thematique.thematique.nom }}</p>

    <div style="margin-top: 20px;">
        <a href="{% url 'ajouter_graphique' slug=sous_thematique.slug %}" class="btn btn-primary">
            ‚ûï Ajouter un graphique
        </a>
    </div>

    <div class="graph-placeholder">
        {% for graph in graphiques %}
            <div class="graph-block" style="margin-top: 40px;">
                <h3>{{ graph.titre }} ({{ graph.get_type_display }})</h3>
                <p>{{ graph.description }}</p>

                <canvas id="chart{{ graph.id }}" height="120"></canvas>

                <div style="margin-top: 10px;">
                    <a href="{% url 'modifier_graphique' graph.id %}">‚úèÔ∏è Modifier</a> |
                    <a href="#" onclick="openDeleteModal({{ graph.id }}, '{{ graph.titre }}')">üóëÔ∏è Supprimer</a>
                </div>

                <script>
                    const ctx{{ graph.id }} = document.getElementById('chart{{ graph.id }}').getContext('2d');
                    const chart{{ graph.id }} = new Chart(ctx{{ graph.id }}, {
                        type: '{{ graph.type }}',
                        data: {
                            labels: {% if graph.series.all|length > 0 %}{{ graph.series.first.categories|safe }}{% else %}[] {% endif %},
                            datasets: [
                                {% for serie in graph.series.all %}
                                    {
                                        label: "{{ serie.nom }}",
                                        data: {{ serie.valeurs|safe }},
                                        {% if graph.type == "pie" and serie.couleurs_camembert %}
                                            backgroundColor: {{ serie.couleurs_camembert|safe }},
                                        {% else %}
                                            backgroundColor: "{{ serie.couleur|default:'#3e95cd' }}",
                                        {% endif %}
                                        borderColor: "#333",
                                        borderWidth: 1
                                    },
                                {% endfor %}
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: "{{ graph.titre }}" }
                            },
                            {% if graph.type != 'pie' %}
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: "{{ graph.titre_abscisse|default:'' }}"
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: "{{ graph.titre_ordonn√©e|default:'' }}"
                                    }
                                }
                            }
                            {% endif %}
                        }
                    });
                </script>
            </div>
        {% empty %}
            <p style="margin-top: 30px;">Aucun graphique pour cette sous-th√©matique.</p>
        {% endfor %}
    </div>
</div>

<!-- üî• Modal de suppression -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDeleteModal()">√ó</span>
        <h3>üóëÔ∏è Supprimer le graphique</h3>
        <p id="modal-text"></p>
        <form id="delete-form" method="post" style="margin-top: 15px;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">‚úÖ Oui, supprimer</button>
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">‚ùå Annuler</button>
        </form>
    </div>
</div>

<script src="{% static 'js/modal_delete_chart.js' %}"></script>
{% endblock %}
