{% extends "base.html" %}
{% load static %}
{% block title %}Modifier un graphique{% endblock %}

{% block content %}
<!-- Mode JS : EDIT -->
<div id="mode" data-mode="edit" hidden></div>
<link rel="stylesheet" href="{% static 'css/insee.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="graph-builder">
    <!-- üìã Formulaire -->
    <div class="sidebar">
        <h4>Modifier le graphique : {{ graphique.titre }}</h4>

        <!-- Alerte camembert -->
        <div id="chart-warning" class="alert-box" style="display: none;">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div class="alert-content">
                <strong>Attention :</strong><br>
                Le type "camembert" n'accepte qu'une seule s√©rie. Les s√©ries suppl√©mentaires ont √©t√© supprim√©es.
            </div>
            <span class="alert-close" onclick="this.parentElement.style.display='none'">‚úñ</span>
        </div>

        <form method="post" onsubmit="prepareSeriesData(event)">
            {% csrf_token %}
            {{ graph_form.as_p }}

            <label><strong>Titre abscisses :</strong></label>
            <input type="text" id="titre-x" value="{{ graphique.titre_abscisse }}"><br>

            <label><strong>Titre ordonn√©es :</strong></label>
            <input type="text" id="titre-y" value="{{ graphique.titre_ordonn√©e }}"><br><br>

            <label><strong>Cat√©gories :</strong></label>
            <input type="text" id="categories-global" value="{{ series.0.categories|join:', ' }}" required><br><br>

            <h3>S√©ries de donn√©es</h3>
            <div id="series-container"></div>

            <button type="button" id="add-serie-btn" onclick="addSerie()">‚ûï Ajouter une s√©rie</button>
            <input type="hidden" name="series_data" id="series-data-json">
            <br><br>

            <button type="submit">üíæ Enregistrer les modifications</button>
        </form>
    </div>

    <!-- üìä Aper√ßu -->
    <div class="main-panel">
        <h3 id="preview-title">Aper√ßu du graphique</h3>
        <canvas id="preview-chart"></canvas>
    </div>
</div>

<!-- Template JS √† cloner -->
<template id="serie-template">
    <div class="serie-block" style="border:1px solid #ccc;padding:10px;margin:10px 0;">
        <label>Nom :</label>
        <input type="text" class="serie-nom"><br>

        <label>Valeurs :</label>
        <input type="text" class="serie-valeurs"><br>

        <label>Couleur :</label>
        <input type="color" class="serie-couleur" value="#3e95cd"><br>

        <button type="button" onclick="this.parentElement.remove()">‚ùå Supprimer</button>
    </div>
</template>

<!-- JS preview + injection des s√©ries -->
<script src="{% static 'js/graph_preview.js' %}"></script>
<script src="{% static 'js/prepare_series.js' %}"></script>

<script>
    // ‚ö° Injecte dynamiquement les s√©ries du graphique (pass√©es via le contexte)
    document.addEventListener("DOMContentLoaded", function () {
        const seriesData = [
            {% for serie in series %}
                {
                    nom: "{{ serie.nom|escapejs }}",
                    valeurs: {{ serie.valeurs|safe }},
                    couleur: "{{ serie.couleur }}",
                },
            {% endfor %}
        ];

        // Cr√©e dynamiquement les champs avec les valeurs existantes
        for (const serie of seriesData) {
            addSerie();
            const block = document.querySelectorAll('.serie-block')[document.querySelectorAll('.serie-block').length - 1];
            block.querySelector('.serie-nom').value = serie.nom;
            block.querySelector('.serie-valeurs').value = serie.valeurs.join(", ");
            block.querySelector('.serie-couleur').value = serie.couleur;
        }

        updateChartPreview();
    });
</script>
{% endblock %}
