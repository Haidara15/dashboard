{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/importer_excel.css' %}">

<div class="excel-container">
  <div class="excel-sidebar">
    <h2>ðŸ“‚ Importer Excel</h2>

    <form id="excel-upload-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="excel_file" id="excel-file" accept=".xlsx" required>
    </form>

    <form method="post" action="{% url 'creer_graphique_excel' slug=slug %}">
      {% csrf_token %}

      <div id="colonnes-container"></div>

      <label for="id_titre">Titre :</label>
      <input type="text" name="titre" id="id_titre" required>

      <label for="id_type">Type de graphique :</label>
      <select name="type" id="id_type">
        <option value="bar" selected>Barres</option>
        <option value="line">Lignes</option>
        <option value="pie">Camembert</option>
      </select>

      <label for="id_description">Description :</label>
      <textarea name="description" id="id_description" rows="3"></textarea>

      <label for="titre-x">Titre axe X :</label>
      <input type="text" name="titre-x" id="titre-x">

      <label for="titre-y">Titre axe Y :</label>
      <input type="text" name="titre-y" id="titre-y">

      <input type="hidden" name="series_data" id="series-data-json">

      <button type="submit" class="submit-btn">âœ… Enregistrer le graphique</button>
    </form>
  </div>

  <div class="excel-main">
    <canvas id="preview-chart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  let excelColumns = [];
  let selectedX = null;
  let selectedY = [];

  document.getElementById('excel-file').addEventListener('change', function () {
    const form = document.getElementById('excel-upload-form');
    const formData = new FormData(form);

    fetch("", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        excelColumns = data.columns;
        renderColumnCheckboxes();
      } else {
        alert("Erreur: " + data.message);
      }
    });
  });

  function renderColumnCheckboxes() {
    const container = document.getElementById("colonnes-container");
    container.innerHTML = `
      <h4>Colonne pour les catÃ©gories :</h4>
      ${excelColumns.map(col => `
        <label><input type="radio" name="categorie" value="${col}"> ${col}</label><br>
      `).join('')}

      <h4>Colonnes des sÃ©ries :</h4>
      ${excelColumns.map((col, index) => {
        const defaultColor = `hsl(${(index * 60) % 360}, 70%, 60%)`;
        return `
          <label>
            <input type="checkbox" class="serie-checkbox" value="${col}">
            ${col}
            <input type="color" class="serie-color" data-nom="${col}" value="${defaultColor}">
          </label><br>
        `;
      }).join('')}

      <p id="pie-warning" style="display:none; color: #888; font-style: italic;">
        Pour un camembert, une seule sÃ©rie est autorisÃ©e.
      </p>
    `;

    document.querySelectorAll('input[name="categorie"]').forEach(radio => {
      radio.addEventListener('change', updateSelection);
    });

    applyPieBehavior();
    updateSelection();
  }

  function applyPieBehavior() {
    const type = document.getElementById("id_type").value;
    const checkboxes = document.querySelectorAll('.serie-checkbox');
    const warning = document.getElementById("pie-warning");

    if (type === "pie") {
      warning.style.display = "block";
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      if (checked.length > 1) {
        checked.forEach((cb, index) => {
          cb.checked = index === checked.length - 1;
        });
      }
      checkboxes.forEach(cb => {
        cb.onclick = function () {
          if (this.checked) {
            checkboxes.forEach(other => {
              if (other !== this) other.checked = false;
            });
          }
          updateSelection();
        };
      });
    } else {
      warning.style.display = "none";
      checkboxes.forEach(cb => {
        cb.onclick = () => updateSelection();
      });
    }
  }

  function updateSelection() {
    selectedX = document.querySelector('input[name="categorie"]:checked')?.value;
    selectedY = Array.from(document.querySelectorAll('.serie-checkbox:checked')).map(cb => cb.value);

    if (selectedX && selectedY.length > 0) {
      genererPreview();
    }
  }

  function genererPreview() {
    const chartType = document.getElementById("id_type").value;

    const activeSeries = Array.from(document.querySelectorAll('.serie-checkbox:checked')).map(cb => {
      const colName = cb.value;
      const colorInput = document.querySelector(`.serie-color[data-nom="${colName}"]`);
      const color = colorInput ? colorInput.value : "#3e95cd";

      return {
        nom: colName,
        couleur: color
      };
    });

    fetch("/api/generer-graphique-preview/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        categorie: selectedX,
        series: activeSeries
      })
    })
    .then(res => res.json())
    .then(data => {
      if (window.previewChart) window.previewChart.destroy();

      let series = data.series_data || [];

      if (chartType === "pie" && series.length > 1) {
        series = [series[0]];
      }

      window.previewChart = new Chart(document.getElementById("preview-chart"), {
        type: chartType,
        data: {
          labels: data.labels,
          datasets: series.map(serie => ({
            label: serie.nom,
            data: serie.valeurs,
            backgroundColor: chartType === "pie" ? serie.couleurs_camembert : serie.couleur,
            borderColor: chartType === "pie" ? [] : "#333",
            borderWidth: 1
          }))
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: document.getElementById("id_titre").value || "AperÃ§u" }
          },
          scales: chartType !== "pie" ? {
            x: { title: { display: true, text: document.getElementById("titre-x").value } },
            y: { title: { display: true, text: document.getElementById("titre-y").value } }
          } : {}
        }
      });

      document.getElementById("series-data-json").value = JSON.stringify(series);
    });
  }

  document.addEventListener("input", function (e) {
    if (["id_titre", "titre-x", "titre-y"].includes(e.target.id)) {
      updateSelection();
    }
  });

  const formulaire = document.querySelector('form[action*="creer_graphique_excel"]');
  if (formulaire) {
    formulaire.addEventListener("submit", function (e) {
      const seriesField = document.getElementById("series-data-json");
      if (!seriesField.value || seriesField.value === "[]") {
        e.preventDefault();
        updateSelection();
        setTimeout(() => {
          if (!seriesField.value || seriesField.value === "[]") {
            alert("Veuillez sÃ©lectionner une catÃ©gorie et au moins une sÃ©rie.");
          } else {
            this.submit();
          }
        }, 300);
      }
    });
  }

  document.getElementById("id_type").addEventListener("change", () => {
    applyPieBehavior();
    updateSelection();
  });
});
</script>

{% endblock %}
