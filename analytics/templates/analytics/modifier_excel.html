{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/importer_excel.css' %}">

<div class="excel-container">
  <div class="excel-sidebar">
    <h2 style="padding:20px 0px;">‚úèÔ∏è Modifier le graphique</h2>

    <!-- Fichier Excel -->
    <form id="excel-upload-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <label for="excel-file" style="font-weight: bold;">üìÅ Recharger un fichier Excel :</label><br>
      <input type="file" name="excel_file" id="excel-file" accept=".xlsx" style="margin-top: 5px;">
      <p style="font-size: 0.85em; color: #666;">(Remplace les donn√©es actuelles. Le fichier ne sera pas enregistr√© si vous n'enregistrez pas le graphique ensuite.)</p>
    </form>

    <!-- Form principal -->
    <form method="post" action="{% url 'modifier_graphique_excel' graph_id=graphique.id %}" id="edit-graph-form">
      {% csrf_token %}
      <label for="id_titre">Titre :</label>
      <input type="text" name="titre" id="id_titre" value="{{ graphique.titre }}" required>

      <label for="id_type">Type de graphique :</label>
      <select name="type" id="id_type">
        <option value="bar" {% if graphique.type == 'bar' %}selected{% endif %}>Barres</option>
        <option value="line" {% if graphique.type == 'line' %}selected{% endif %}>Lignes</option>
        <option value="pie" {% if graphique.type == 'pie' %}selected{% endif %}>Camembert</option>
      </select>

      <label for="id_description">Description :</label>
      <textarea name="description" id="id_description" rows="3">{{ graphique.description }}</textarea>

      <label for="titre-x">Titre axe X :</label>
      <input type="text" name="titre-x" id="titre-x" value="{{ graphique.titre_abscisse }}">

      <label for="titre-y">Titre axe Y :</label>
      <input type="text" name="titre-y" id="titre-y" value="{{ graphique.titre_ordonn√©e }}">

      <div id="colonnes-container"></div>

      <input type="hidden" name="categorie_selectionnee" id="categorie-selectionnee">
      <input type="hidden" name="series_data" id="series-data-json">
      <button type="submit" class="submit-btn">‚úÖ Enregistrer les modifications</button>
    </form>
  </div>

  <div class="excel-main">
    <canvas id="preview-chart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  let colonnes = {{ colonnes_disponibles|safe }};
  const categorieSelectionnee = "{{ categorie_colonne }}";
  let seriesData = {{ series_data|safe }};
  let excelRows = {{ excel_rows|safe }};
  let defaultCategories = {{ categorie_sample|safe }};

  const titreInput = document.getElementById("id_titre");
  const typeSelect = document.getElementById("id_type");
  const titreXInput = document.getElementById("titre-x");
  const titreYInput = document.getElementById("titre-y");

  function renderColumnCheckboxes() {
    const container = document.getElementById("colonnes-container");
    container.innerHTML = `
      <h4>Colonne des cat√©gories :</h4>
      ${colonnes.map(col => `
        <label><input type="radio" name="categorie" value="${col}" ${col === categorieSelectionnee ? 'checked' : ''}> ${col}</label><br>
      `).join('')}

      <h4>Colonnes des s√©ries :</h4>
      <p id="pie-warning" style="display:none; color:red; font-style: italic;margin:10px 0px;">
        Pour un camembert, une seule s√©rie est autoris√©e.
      </p>

      ${colonnes.map(col => {
        const existingSerie = seriesData.find(s => s.nom === col);
        const defaultColor = existingSerie?.couleur || `hsl(${(colonnes.indexOf(col) * 60) % 360}, 70%, 60%)`;

        return `
          <label>
            <input type="checkbox" class="serie-checkbox" value="${col}" ${existingSerie ? 'checked' : ''}>
            ${col}
            <input type="color" class="serie-color" data-nom="${col}" value="${defaultColor}">
          </label><br>
        `;
      }).join('')}
    `;

    document.querySelectorAll(".serie-checkbox").forEach(cb => {
      cb.addEventListener("change", updatePreview);
    });

    document.querySelectorAll('input[name="categorie"]').forEach(input => {
      input.addEventListener('change', updatePreview);
    });

    applyPieBehavior();
  }

  function applyPieBehavior() {
    const type = typeSelect.value;
    const checkboxes = document.querySelectorAll('.serie-checkbox');
    const warning = document.getElementById("pie-warning");

    if (type === "pie") {
      warning.style.display = "block";
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      if (checked.length > 1) {
        checked.forEach((cb, index) => {
          cb.checked = index === 0;
        });
      }
      checkboxes.forEach(cb => {
        cb.onclick = function () {
          if (this.checked) {
            checkboxes.forEach(other => {
              if (other !== this) other.checked = false;
            });
          }
          updatePreview();
        };
      });
    } else {
      warning.style.display = "none";
      checkboxes.forEach(cb => {
        cb.onclick = () => updatePreview();
      });
    }
  }

  function updatePreview() {
    const chartType = typeSelect.value;
    const titre = titreInput.value;
    const titreX = titreXInput.value;
    const titreY = titreYInput.value;

    const selectedCategorie = document.querySelector('input[name="categorie"]:checked');
    let updatedLabels = defaultCategories;
    if (selectedCategorie) {
      const selectedName = selectedCategorie.value;
      document.getElementById("categorie-selectionnee").value = selectedName;
      updatedLabels = excelRows.map(row => row[selectedName]);
    }

    const activeSeries = Array.from(document.querySelectorAll(".serie-checkbox:checked")).map(cb => {
      const colName = cb.value;
      const colorInput = document.querySelector(`.serie-color[data-nom="${colName}"]`);
      const color = colorInput ? colorInput.value : "#3e95cd";

      return {
        nom: colName,
        categories: updatedLabels,
        valeurs: excelRows.map(row => row[colName]),
        couleur: color,
        couleurs_camembert: excelRows.map((_, i) => `hsl(${(i * 50) % 360}, 70%, 60%)`)
      };
    });

    if (chartType === 'pie' && activeSeries.length > 1) {
      activeSeries.splice(1);
    }

    if (window.previewChart) window.previewChart.destroy();

    window.previewChart = new Chart(document.getElementById("preview-chart"), {
      type: chartType,
      data: {
        labels: updatedLabels,
        datasets: activeSeries.map(serie => ({
          label: serie.nom,
          data: serie.valeurs,
          backgroundColor: chartType === "pie" ? serie.couleurs_camembert : serie.couleur,
          borderColor: chartType === "pie" ? [] : "#333",
          borderWidth: 1
        }))
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: titre }
        },
        scales: chartType !== "pie" ? {
          x: { title: { display: true, text: titreX } },
          y: { title: { display: true, text: titreY } }
        } : {}
      }
    });

    document.getElementById("series-data-json").value = JSON.stringify(activeSeries);
  }

  document.getElementById("excel-file").addEventListener("change", function () {
    const form = document.getElementById("excel-upload-form");
    const formData = new FormData(form);

    fetch("", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        colonnes = data.columns;
        renderColumnCheckboxes();
        updatePreview();
      } else {
        alert("Erreur: " + data.message);
      }
    });
  });

  [titreInput, titreXInput, titreYInput, typeSelect].forEach(el => {
    el.addEventListener("input", updatePreview);
    el.addEventListener("change", () => {
      updatePreview();
      applyPieBehavior();
    });
  });

  renderColumnCheckboxes();
  updatePreview();
});
</script>

{% endblock %}
